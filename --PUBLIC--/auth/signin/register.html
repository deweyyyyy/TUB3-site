<!doctype html>
<html lang="en">
  <head>
    <script src="https://kit.fontawesome.com/0f81b9a2a2.js" crossorigin="anonymous"></script>
    <link href="../css/a.css" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" ></script>
    <script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-storage.js"></script> 
   <script src="https://www.gstatic.com/firebasejs/7.13.1/firebase-database.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Dewey's World Team">
    <meta name="generator" content="Hugo 0.101.0">
    <title>Registration : Tub3 Auth</title>
    <link rel="canonical" href="https://getbootstrap.com/docs/5.2/examples/sign-in/">
    <link href="https://getbootstrap.com/docs/5.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <!-- Favicons -->
    
    <link rel="icon" href="./files/image/logo3.png" sizes="32x32" type="image/png">
    <link rel="manifest" href="https://getbootstrap.com/docs/5.2/assets/img/favicons/manifest.json">
    
    <meta name="theme-color" content="#f5f5f5">
  </head>
 <script>
    var config = {
      apiKey: "AIzaSyAx7uPGRjJvpNYD0twbk8_hg_BCEG1A36g",
      authDomain: "tub3skku.firebaseapp.com",
      databaseURL: "https://tub3skku-default-rtdb.firebaseio.com",
      projectId: "tub3skku",
      storageBucket: "tub3skku.appspot.com",
      messagingSenderId: "944059952794",
      appId: "1:944059952794:web:b34765015204fdee8d3923"
    };
    firebase.initializeApp(config);
  </script>
  <body class="text-center">   
  <main class="form-signin w-100 m-auto">
        <!--MENU-->
        <script src="https://kit.fontawesome.com/0f81b9a2a2.js" crossorigin="anonymous"></script><script src="https://use.fontawesome.com/releases/v6.4.2/js/all.js" ></script>
        <div class="menu-left"><a href="../../menu/index.html"><h1><i class="fa-solid fa-bars"></i>&nbsp;Menu</h1></a>
          <style>.menu-left {text-align: left;}.menu-left h1 {display: flex;align-items: center;font-size: 18px;color: #000000;}.menu i.fa-bars {margin-right: 10px;}</style></div>
          <!--MENU-->
    <!--Cookie-->
    <style>
      .acookie { color: blue; text-decoration: none; }
      .alertcookie { display: none; padding: 20px; font-size: 12px; background-color: #f1ffba; color: rgb(0, 0, 0); border-radius: 20px; }
      .closecookie { margin-left: 15px; color: rgb(84, 84, 84); font-weight: bold; float: right; font-size: 22px; line-height: 20px; cursor: pointer; transition: 0.3s; }
      .closecookie:hover { color: rgb(255, 30, 30); }
    </style>
    
    <script>
      // Function to set a cookie with a given name, value, and expiration time
      function setCookie(name, value, minutes) {
        var d = new Date();
        d.setTime(d.getTime() + (minutes * 60 * 1000));
        var expires = "expires=" + d.toUTCString();
        document.cookie = name + "=" + value + ";" + expires + ";path=/";
      }
    
      // Function to get the value of a cookie by name
      function getCookie(name) {
        var decodedCookie = decodeURIComponent(document.cookie);
        var cookies = decodedCookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.indexOf(name + "=") === 0) {
            return cookie.substring(name.length + 1);
          }
        }
        return "";
      }
    
      // Function to handle the click event on the close button
      function closeCookieBanner() {
        // Set a cookie named 'closedCookieBanner' with value 'true' and expiration time of 10 minutes
        setCookie('closedCookieBanner', 'true', 10);
        // Hide the cookie banner
        document.querySelector('.alertcookie').style.display = 'none';
      }
    
      // Function to check if the cookie banner should be displayed
      function checkCookieBanner() {
        // Get the value of the 'closedCookieBanner' cookie
        var closedCookieBanner = getCookie('closedCookieBanner');
        // Check if the cookie is not set or if it's been more than 10 minutes since it was set
        if (closedCookieBanner === '' || (closedCookieBanner === 'true' && Date.now() - new Date(closedCookieBanner) > 10 * 60 * 1000)) {
          // Show the cookie banner
          document.querySelector('.alertcookie').style.display = 'block';
        }
      }
    
      // Call the checkCookieBanner function when the page loads
      window.onload = checkCookieBanner;
    </script>
    
    <div class="alertcookie">
      <span class="closecookie" onclick="closeCookieBanner();">&times;</span>
      <strong>Cookies </strong>เราใช้คุ๊กกี้เพื่อเพิ่มประสบการณ์การใช้งานของคุณให้สมบูรณ์และมีประสิทธิภาพมากขึ้น ถ้าท่านใช้งานเว็บไซต์ของเราต่อไปถือว่าท่านได้ยอมรับ <a class="acookie" href="/privacy">นโยบายการคุ้มครองข้อมูลส่วนบุคคล</a>ของเราแล้ว
    </div>
    <!--Cookie-->

    <img class="mb-4" src="https://firebasestorage.googleapis.com/v0/b/free-cloud-de.appspot.com/o/logo3.png?alt=media" alt="" width="100" height="100">
    <h1 class="h3 mb-3 fw-normal">Tub3 Auth : User Registration</h1>

    <div class="container">
  
        <br /><br />
    
          <div id="login_panel" class='text-right' >

 <p id="stMessage"></p>

   <div id="signupmail" class="signupmail">
    <form id="registration-form">
      <label for="username">Username:</label>
      <input class="new-username" type="text" id="username" required><br>
      
      <label for="email">Email:</label>
      <input class="new-email" type="email" id="email" required><br>
      
      <label for="password">Password:</label>
      <input class="new-password" type="password" id="password" required><br>
      
      <div>
        <input type="file" id="profile-picture" class="hidden-input" accept="image/*">
        <label for="profile-picture" class="custom-button">Choose a Profile Picture</label>
      </div>
      <br>
      
      <button type="submit" class="btn_login2 "  >
        <i class="fa-solid fa-envelope"></i> Register
      </button><br><br><br><br>
    </form>
   </div>
   <p id="message"></p>
  <a href="./index.html"><h6>Login with Google/Email&Password?</h6></a>
  <button class="btn_login "  >
    <i class="fa fa-key" ></i> Sign In with <img style="height: 50%;" src="https://www.google.com/images/branding/googlelogo/2x/googlelogo_dark_color_272x92dp.png">
</button>       <button class="btn_sign_out " style="display:none" >
<i class="fa fa-sign-out-alt" ></i> Sign Out
</button>
             <br>
             <br>

    
              <!--  สร้าง span สำหรับ  --> 
              <span class="user_info" ></span>
              <!--  สร้าง ออกจากระบบ ระบบโดยกำหนดให้ยังไม่แสดงในครั้งแรก  --> 
             
              <br><br>
              <a href="javascript:history.back()"><i class="fa-solid fa-backward"></i> Back</a>





<br><br><br><br>


              <div class="container">
                <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
                  <p class="col-md-4 mb-0 text-muted">&copy; 2023 Dewey's World</p>
                  
              
                  <a href="/" class="col-md-4 d-flex align-items-center justify-content-center mb-3 mb-md-0 me-md-auto link-dark text-decoration-none">
                    <img src="https://firebasestorage.googleapis.com/v0/b/free-cloud-de.appspot.com/o/logo2.png?alt=media" class="footer-logo">
                  </a>
              
                  <ul class="nav col-md-4 justify-content-end">
  
                    <li class="nav-item"><a href="/" class="nav-link px-2 text-muted"><i class="fa-solid fa-house"></i> Home</a></li>
                    <li class="nav-item"><a href="/certificate/" class="nav-link px-2 text-muted"><i class="fa-solid fa-certificate"></i> Certificate</a></li>
                    <li class="nav-item"><a href="/auth/account/" class="nav-link px-2 text-muted"><i class="fa-solid fa-user"></i> Account</a></li>
                    <!--<li class="nav-item"><a href="#" class="nav-link px-2 text-muted">FAQs</a></li>
                    <li class="nav-item"><a href="#" class="nav-link px-2 text-muted">About</a></li> --> 
                  </ul>             
                </footer>
              </div>
        </div>
        
    <style>
      
    </style>
        <script>
          var timestampa = new Date().getTime();
          var currentURL = window.location.href;
          
          // Sign in with Google
          $("#login_panel").find(".btn_login").on("click", function () {
            var GoogleAuthProvider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(GoogleAuthProvider);
          });
          
          const registrationContainer = document.getElementById('signupmail');
          const registrationForm = document.getElementById('registration-form');
          const message = document.getElementById('message');

          document.getElementById('profile-picture').addEventListener('change', function() {
            const input = this;
            const label = input.nextElementSibling;
            const file = input.files[0];
          
            if (file) {
              const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
              if (allowedTypes.includes(file.type)) {
                label.innerHTML = 'File selected';
              } else {
                label.innerHTML = 'Invalid file type';
                input.value = ''; // Clear the input if an invalid file is selected
              }
            } else {
              label.innerHTML = 'Choose a Profile Picture';
            }
          });
          
          registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const profilePicture = document.getElementById('profile-picture').files[0];
            const stMessage = document.getElementById("stMessage");
          
            try {
              const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
              const user = userCredential.user;
              await user.updateProfile({
                displayName: username
              });
          
              if (profilePicture) {
                const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
                if (allowedTypes.includes(profilePicture.type)) {
                  const storageRef = firebase.storage().ref(`profile_pictures/${user.uid}`);
                  const uploadTask = storageRef.put(profilePicture);
          
                  uploadTask.on(
                    'state_changed',
                    (snapshot) => {
                      // Progress monitoring (optional)
                      const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                      console.log(`Upload is ${progress}% done`);
                      stMessage.innerHTML = `Uploading your profile photo: ${progress}% done`;
                    },
                    (error) => {
                      // Handle the upload error
                      console.error('Upload error:', error);
                    },
                    async () => {
                      // Upload complete, get the download URL
                      const downloadURL = await storageRef.getDownloadURL();
                    
                      // Update user profile
                      await user.updateProfile({
                        photoURL: downloadURL
                      });
                    
                      // Log the updated user object
                      console.log('Updated user object:', user);
                    
                      message.textContent = 'User registered successfully with a profile picture.';
                      alert("Username: " + username + " registered successfully with a profile picture and " + email);
                      registrationContainer.style.display = 'none';
                      console.log('File available at', downloadURL);
                      window.location.href = "../account/index.html";
                    }
                    
                  );
                } else {
                  label.innerHTML = 'Invalid file type';
                  input.value = ''; // Clear the input if an invalid file is selected
                }
              } else {
                // No profile picture selected
                message.textContent = 'User registered successfully without a profile picture.';
                alert("Username: " + username + " registered successfully without a profile picture and " + email);
                registrationContainer.style.display = 'none';
                window.location.href = "../account/index.html";
              }
            } catch (error) {
              const errorMessage = error.message;
              message.textContent = errorMessage;
              alert(errorMessage);
              console.error(error);
            }
          });
                   
          
          $("#login_panel").find(".btn_login2").on("click", function () {
            var email = $("#email_input").val();
            var password = $("#password_input").val();
            firebase.auth().signInWithEmailAndPassword(email, password)
              .then(function (userCredential) {
                var user = userCredential.user;
                alert("Authentication successful for user: " + user.email);
              })
              .catch(function (error) {
                var errorCode = error.code;
                var errorMessage = error.message;
                alert("Authentication failed: " + errorCode + " - " + errorMessage);
              });
          });
          
          // Sign out
          $("#login_panel").find(".btn_sign_out").on("click", function () {
            firebase.auth().signOut().then(function () {
              // Handle sign-out success if needed
            });
          });
          
          // User state change
          firebase.auth().onAuthStateChanged(function (user) {
            if (user) {
              console.log(user);
              $("#login_panel").find(".btn_login").css("display", "none");
              $("#login_panel").find(".signupmail").css("display", "none");
              $("#login_panel").find(".btn_sign_out").css("display", "");
              $("#login_panel").find(".user_info").html(user.displayName);
          
              firebase.database().ref(timestampa + " UserID-" + user.uid).set({
                what: "join",
                where: currentURL
              }).then(function () {
                console.log("Data saved successfully");
              }).catch(function (error) {
                console.error("Error saving data to Firebase:", error);
              });
          
              // Redirect user to another page after registration (uncomment if needed)
              // setTimeout(() => {
              //   window.location.href = "../account/index.html";
              // }, 3000);
            } else {
              $("#login_panel").find(".btn_login").css("display", "");
              $("#login_panel").find(".signupmail").css("display", "");
              $("#login_panel").find(".btn_sign_out").css("display", "none");
              $("#login_panel").find(".user_info").html("");
              firebase.database().ref(timestampa + " NOUSER").set({
                what: "join",
                where: currentURL
              }).then(function () {
                console.log("Data saved successfully");
              }).catch(function (error) {
                console.error("Error saving data to Firebase:", error);
              });
            }
          });
          
        </script>
    
    </div>
    
    
    


    

</main>


  </body>
</html>

